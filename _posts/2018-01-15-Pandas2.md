---
layout: mypost
title: Pandas Feature Engineering
categories: [Pandas]
---

### Import and Read


```python
import pandas as pd
import numpy as np
import warnings
warnings.filterwarnings('ignore')
data = pd.read_csv('ad_feature.csv')
```

### Discretize Feature (Feature Enginnering)


```python
np.linspace(0, 1, 11)
```




    array([0. , 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1. ])



**out**: gives a bin for every data point

**bin**: value ranges


```python
out, bins = pd.qcut(data['price'], q=np.linspace(0, 1, 11), retbins=True, duplicates='drop')
bins
```




    array([1.0000000e-02, 1.7370000e+01, 3.8000000e+01, 6.3800000e+01,
           9.8000000e+01, 1.3900000e+02, 1.9800000e+02, 2.8800000e+02,
           4.3900000e+02, 9.7000000e+02, 9.9999999e+07])




```python
label, cate = pd.factorize(out, sort=True)
data['price_level'] = label
cate
```




    CategoricalIndex([(0.009000000000000001, 17.37],                 (17.37, 38.0],
                                       (38.0, 63.8],                  (63.8, 98.0],
                                      (98.0, 139.0],                (139.0, 198.0],
                                     (198.0, 288.0],                (288.0, 439.0],
                                     (439.0, 970.0],
                                (970.0, 99999999.0]],
                     categories=[(0.009000000000000001, 17.37], (17.37, 38.0], (38.0, 63.8], (63.8, 98.0], (98.0, 139.0], (139.0, 198.0], (198.0, 288.0], (288.0, 439.0], ...], ordered=True, dtype='category')




```python
data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>adgroup_id</th>
      <th>cate_id</th>
      <th>campaign_id</th>
      <th>customer</th>
      <th>brand</th>
      <th>price</th>
      <th>price_level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>63133</td>
      <td>6406</td>
      <td>83237</td>
      <td>1</td>
      <td>95471.0</td>
      <td>170.00</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>313401</td>
      <td>6406</td>
      <td>83237</td>
      <td>1</td>
      <td>87331.0</td>
      <td>199.00</td>
      <td>6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>248909</td>
      <td>392</td>
      <td>83237</td>
      <td>1</td>
      <td>32233.0</td>
      <td>38.00</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>208458</td>
      <td>392</td>
      <td>83237</td>
      <td>1</td>
      <td>174374.0</td>
      <td>139.00</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>110847</td>
      <td>7211</td>
      <td>135256</td>
      <td>2</td>
      <td>145952.0</td>
      <td>32.99</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>



### Outlier (Feature Engeering)

use **quatile** to deal with outliers


```python
qua = data['price'].describe()
print(qua)
```

    count    8.468110e+05
    mean     1.838867e+03
    std      3.108877e+05
    min      1.000000e-02
    25%      4.900000e+01
    50%      1.390000e+02
    75%      3.520000e+02
    max      1.000000e+08
    Name: price, dtype: float64



```python
max_val = qua['50%'] + 3 * (qua['75%'] - qua['50%'])
data['price'] = data.price.clip(0, max_val)
data.price.describe()
```




    count    846811.000000
    mean        243.996387
    std         253.800315
    min           0.010000
    25%          49.000000
    50%         139.000000
    75%         352.000000
    max         778.000000
    Name: price, dtype: float64



**normal distribution**: mean - 3 \* std , mean + 3 \* std


```python
mean = data['price'].mean() 
std = data['price'].std()
valid_max = mean + 3 * std
data['price'] = data['price'].clip( 0 , valid_max)  
```

### One-hot Encoding


```python
pd.get_dummies(data[:10]['cate_id'])
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>392</th>
      <th>4520</th>
      <th>5953</th>
      <th>6261</th>
      <th>6406</th>
      <th>7207</th>
      <th>7211</th>
      <th>7213</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>



### Correlation


```python
data[:20].corr()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>adgroup_id</th>
      <th>cate_id</th>
      <th>campaign_id</th>
      <th>customer</th>
      <th>brand</th>
      <th>price</th>
      <th>price_level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>adgroup_id</th>
      <td>1.000000</td>
      <td>-0.191058</td>
      <td>-0.352587</td>
      <td>0.379174</td>
      <td>0.335265</td>
      <td>-0.022691</td>
      <td>0.218342</td>
    </tr>
    <tr>
      <th>cate_id</th>
      <td>-0.191058</td>
      <td>1.000000</td>
      <td>0.280272</td>
      <td>0.210965</td>
      <td>-0.074811</td>
      <td>0.065262</td>
      <td>0.021730</td>
    </tr>
    <tr>
      <th>campaign_id</th>
      <td>-0.352587</td>
      <td>0.280272</td>
      <td>1.000000</td>
      <td>0.075308</td>
      <td>-0.037957</td>
      <td>0.518634</td>
      <td>0.376915</td>
    </tr>
    <tr>
      <th>customer</th>
      <td>0.379174</td>
      <td>0.210965</td>
      <td>0.075308</td>
      <td>1.000000</td>
      <td>0.430980</td>
      <td>0.473945</td>
      <td>0.459387</td>
    </tr>
    <tr>
      <th>brand</th>
      <td>0.335265</td>
      <td>-0.074811</td>
      <td>-0.037957</td>
      <td>0.430980</td>
      <td>1.000000</td>
      <td>0.603658</td>
      <td>0.433214</td>
    </tr>
    <tr>
      <th>price</th>
      <td>-0.022691</td>
      <td>0.065262</td>
      <td>0.518634</td>
      <td>0.473945</td>
      <td>0.603658</td>
      <td>1.000000</td>
      <td>0.879407</td>
    </tr>
    <tr>
      <th>price_level</th>
      <td>0.218342</td>
      <td>0.021730</td>
      <td>0.376915</td>
      <td>0.459387</td>
      <td>0.433214</td>
      <td>0.879407</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div>



### apply

use **apply** to get price


```python
data[:10].apply(lambda x: x.price, axis=1)
```




    0    170.00
    1    199.00
    2     38.00
    3    139.00
    4     32.99
    5    199.00
    6     99.00
    7     33.00
    8     19.00
    9    428.00
    dtype: float64




```python
data[:10].apply(lambda x: x.mean(), axis=0)
```




    adgroup_id     199243.000
    cate_id          5196.100
    campaign_id    191887.200
    customer            4.900
    brand          139606.875
    price             135.699
    price_level         3.600
    dtype: float64


