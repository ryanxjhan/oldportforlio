---
layout: mypost
title: Write KNN by Hand to Recognize Digits
categories: [KNN]
---

https://www.kaggle.com/c/digit-recognizer


```python
import numpy as np 
import pandas as pd 
import matplotlib.pyplot as plt
```

### Load Data 


```python
data_dir = "input/"

# load csv files to numpy arrays
def load_data(data_dir, train_row):
    train = pd.read_csv(data_dir + "train.csv")
    print(train.shape)
    X_train = train.values[0:train_row,1:]
    y_train = train.values[0:train_row,0]
    
    
    Pred_test = pd.read_csv(data_dir + "test.csv").values
    return X_train, y_train, Pred_test

train_row = 1000 
Origin_X_train, Origin_y_train, Origin_y_test = load_data(data_dir, train_row)
```

    (42000, 785)



```python
print(Origin_X_train.shape, Origin_y_train.shape, Origin_y_test.shape)
```

    (1000, 784) (1000,) (28000, 784)


### Data Split


```python
from sklearn.model_selection import train_test_split

X_train, X_vali, y_train, y_vali = train_test_split(Origin_X_train,
                                                   Origin_y_train,
                                                   test_size = 0.2,
                                                   random_state = 0)

print(X_train.shape, X_vali.shape, y_train.shape, y_vali.shape)
```

    (800, 784) (200, 784) (800,) (200,)



```python
class knn():
    def __init__(self):
        pass

    def train(self, X, y):
        self.X_train = X
        self.y_train = y

    def predict(self, X, num, k=3):
        dataSet = X_train
        labels = y_train
      
        dataSetSize = dataSet.shape[0]

        diffMat = np.tile(X,(dataSetSize,1)) - dataSet
        sqDiffMat = diffMat**2
        sumDiffMat = sqDiffMat.sum(axis=1)
        distances = sumDiffMat**0.5
        sortedDistances = distances.argsort()
        classCount = {}
        
        for i in range(k):
            vote = labels[sortedDistances[i]]
            classCount[vote] = classCount.get(vote,0) + 1
        max = 0
        ans = 0
        for k,v in classCount.items():
            if(v>max):
                ans = k
                max = v
#         print("test #"+ str(num+1) + " prediction is " + str(ans)
        return(ans)
```

### Find Best K 


```python
from sklearn.metrics import accuracy_score

classifier = knn()
classifier.train(X_train, y_train)

max = 0
ans_k = 0

for k in range(1, 4):
    print ('when k = ' + str(k) + ', start training')
    predictions = np.zeros(len(y_vali))
    for i in range(X_vali.shape[0]):
        if i % 500 == 0:
            print("Computing  " + str(i+1) + "/" + str(int(len(X_vali))) + "...")
        output = classifier.predict(X_vali[i], i, k)
        predictions[i] = output
    
#     print(k, predictions)
#     predictions.shape
    accuracy = accuracy_score(y_vali, predictions)
    print ('k = '+ str(k) , ' accuracy =' + str(accuracy))
    if max < accuracy:
        ans_k = k
        max = accuracy
```

    when k = 1, start training
    Computing  1/200...
    k = 1  accuracy =0.83
    when k = 2, start training
    Computing  1/200...
    k = 2  accuracy =0.83
    when k = 3, start training
    Computing  1/200...
    k = 3  accuracy =0.865



```python
print(y_vali)
print(predictions)
```

    [0 2 2 4 8 3 9 6 2 3 4 9 6 2 7 2 2 8 3 1 9 3 9 3 3 6 6 7 8 0 7 1 9 9 7 3 8
     0 8 0 3 5 0 1 0 0 0 0 3 5 8 1 9 2 8 7 0 6 8 8 5 2 3 6 2 0 0 4 6 2 7 4 5 2
     2 0 5 6 0 7 2 5 7 2 7 6 2 9 1 7 7 4 5 0 0 8 3 0 5 2 2 3 3 7 6 2 7 6 3 8 2
     6 8 2 1 5 2 4 3 2 3 6 4 0 1 7 9 9 7 7 1 6 3 6 4 3 2 5 1 6 2 3 9 1 2 1 9 8
     0 2 2 8 0 0 1 6 9 6 6 9 5 6 1 9 2 4 3 3 4 0 1 0 4 1 3 5 3 1 0 5 6 4 4 6 9
     6 3 3 6 0 2 3 0 0 2 7 0 4 8 3]
    [0. 2. 0. 4. 8. 3. 7. 6. 2. 3. 4. 9. 6. 2. 1. 1. 2. 8. 3. 1. 9. 3. 9. 3.
     5. 6. 6. 7. 8. 0. 7. 1. 7. 7. 7. 3. 3. 0. 9. 0. 3. 5. 0. 1. 6. 0. 0. 0.
     3. 5. 8. 1. 9. 2. 0. 7. 0. 6. 8. 8. 5. 2. 3. 6. 2. 0. 0. 4. 6. 2. 7. 4.
     5. 2. 2. 0. 5. 6. 0. 9. 2. 5. 7. 2. 7. 6. 2. 9. 1. 7. 7. 4. 5. 0. 0. 8.
     2. 0. 5. 7. 2. 3. 3. 7. 6. 2. 7. 6. 3. 8. 2. 6. 8. 2. 1. 5. 2. 4. 3. 2.
     5. 6. 4. 0. 1. 7. 9. 9. 7. 1. 1. 6. 3. 6. 4. 3. 2. 5. 1. 6. 2. 3. 7. 1.
     2. 1. 9. 8. 0. 6. 2. 8. 0. 0. 1. 6. 7. 6. 6. 9. 5. 6. 1. 4. 2. 4. 5. 3.
     7. 0. 1. 0. 4. 1. 5. 5. 2. 1. 0. 5. 6. 4. 4. 6. 5. 6. 3. 7. 6. 0. 2. 3.
     0. 0. 2. 7. 0. 9. 8. 3.]



```python
k = 3
Origin_y_test = Origin_y_test[:300] # remove this line for full test
predictions = np.zeros(Origin_y_test.shape[0])
for i in range(Origin_y_test.shape[0]):
    if i % 100 ==0:
        print("Computing  " + str(i+1) + "/" + str(int(len(Origin_y_test))) + "...")
    predictions[i] = classifier.predict(Origin_y_test[i], i, k)

```

    Computing  1/300...
    Computing  101/300...
    Computing  201/300...



```python
print (predictions[105])
plt.imshow(Origin_y_test[105].reshape((28, 28)))
```

    3.0





    <matplotlib.image.AxesImage at 0x119f06240>




![png](KNN2_12_2.png)



```python
print(len(predictions))
out_file = open("predictions.csv", "w")
out_file.write("ImageId,Label\n")
for i in range(len(predictions)):
    out_file.write(str(i+1) + "," + str(int(predictions[i])) + "\n")
out_file.close()
```

    300

